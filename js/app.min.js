"use strict";var Copy=function(){function Copy(){}return Copy.prototype.CopyToClipBoard=function(toCopy){var body=angular.element(document.body),textarea=angular.element("<textarea/>");textarea.css({position:"fixed",opacity:"0"}),textarea.val(toCopy),body.append(textarea),textarea[0].select();try{var msg=document.execCommand("copy")?"successful . Link has been saved to clipboard. Send it to your friend to start group chat":"unsuccessful. Use manual copy + paste to send the link to your friends.";alert("Copying command was "+msg)}catch(err){alert("Copy to clipboard: Ctrl+C, Enter",toCopy)}textarea.remove()},Copy}(),Noti=function(){function Noti(){}return Noti.prototype.notification=function(event,peer1,peer2){var trigger={videoAdded:{message:peer1+" has joined the room",color:"green"},videoRemoved:{message:peer1+" has left the room",color:"red"},changeName:{message:peer1+" changes their name to "+peer2,color:"blue"}},noti=$("<div class='noti "+trigger[event].color+"'>"+trigger[event].message+"</div>");$("#notification").append(noti);noti.fadeIn("fast"),setTimeout(function(){noti.fadeOut("fast")},250)},Noti}(),ClickCopy=function(){function ClickCopy(ngCopy){return{restrict:"A",link:function(scope,element,attrs){element.bind("click",function(e){ngCopy.CopyToClipBoard(attrs.ngClickCopy)})}}}return ClickCopy.$inject=["ngCopy"],ClickCopy}(),HomeController=function(){function HomeController($scope,$location){this.$scope=$scope,this.$location=$location,this.hostName=this.$location.absUrl()}return HomeController.prototype.createRoom=function(){this.$location.path("/"+this.roomName)},HomeController.$inject=["$scope","$location"],HomeController}(),RoomController=function(){function RoomController($rootScope,$scope,$routeParams,$location,ngNoti){this.$rootScope=$rootScope,this.$scope=$scope,this.$routeParams=$routeParams,this.$location=$location,this.ngNoti=ngNoti,$scope.room=$routeParams.roomName;var webrtc=new SimpleWebRTC({localVideoEl:"localVideo",remoteVideosEl:"",autoRequestMedia:!0,debug:!1,detectSpeakingEvents:!0,autoAdjustMic:!1});webrtc.on("readyToCall",function(){$scope.room&&webrtc.joinRoom($scope.room)}),webrtc.on("localStream",function(stream){var video=stream.getVideoTracks()[0];$("button[name='video']").click(function(){video.enabled=!video.enabled,$("button[name='video']").toggleClass("btn-success").toggleClass("btn-danger"),$("button[name='video'] i").toggleClass("fa-video-camera").toggleClass("fa-pause"),$("#video i").toggleClass("fa-video-camera").toggleClass("fa-pause")});var audio=stream.getAudioTracks()[0];$("button[name='audio']").click(function(){audio.enabled=!audio.enabled,$("button[name='audio']").toggleClass("btn-success").toggleClass("btn-danger"),$("button[name='audio'] i").toggleClass("fa-microphone").toggleClass("fa-microphone-slash"),$("#audio i").toggleClass("fa-microphone").toggleClass("fa-microphone-slash")})}),webrtc.on("localMediaError",function(err){alert("Can't get access to camera")}),webrtc.on("videoAdded",function(video,peer){console.log("video added",peer);var from=void 0!==peer.nick?peer.nick:peer.id;ngNoti.notification("videoAdded",from);var remotes=document.getElementById("remotes");if(remotes){var container=document.createElement("div");if(container.className="col-sm-6",container.id="container_"+webrtc.getDomId(peer),container.appendChild(video),peer&&peer.pc){var connstate_1=document.createElement("div");connstate_1.className="connectionstate text-center",container.appendChild(connstate_1),peer.pc.on("iceConnectionStateChange",function(event){switch(peer.pc.iceConnectionState){case"checking":connstate_1.innerText="Connecting to peer...";break;case"connected":case"completed":connstate_1.innerText="Connection established.","Input your username"!=$scope.nick&&webrtc.sendDirectlyToAll($scope.room,"nick",$scope.nick);break;case"disconnected":connstate_1.innerText="Disconnected.";break;case"failed":connstate_1.innerText="Connection failed.";break;case"closed":connstate_1.innerText="Connection closed."}})}remotes.appendChild(container)}}),webrtc.on("videoRemoved",function(video,peer){console.log("video removed ",peer);var from=void 0!==peer.nick?peer.nick:peer.id;ngNoti.notification("videoRemoved",from);var remotes=document.getElementById("remotes"),el=document.getElementById(peer?"container_"+webrtc.getDomId(peer):"localScreenContainer");remotes&&el&&remotes.removeChild(el)}),webrtc.on("iceFailed",function(peer){var connstate=document.querySelector("#container_"+webrtc.getDomId(peer)+" .connectionstate");console.log("local fail",connstate),connstate&&(connstate.innerText="Connection failed.")}),webrtc.on("connectivityError",function(peer){var connstate=document.querySelector("#container_"+webrtc.getDomId(peer)+" .connectionstate");console.log("remote fail",connstate),connstate&&(connstate.innerText="Connection failed.")}),$scope.url=$location.$$absUrl,$scope.sendMessage=function(){var id=$(".mes.active").attr("id");webrtc.sendDirectlyToAll($scope.room,"chat",$scope.message),"me"!=id&&($(".mes.active").removeClass("active"),$("#conversation").append("<div id='me' class='mes me active'><p class='from'>Me</p><p class='content'></p></div>")),$(".mes.active .content").append($scope.message+"<br>"),$scope.message=""},$scope.nick="Input your username",$scope.editing=!1,$scope.doneEditing=function(){$scope.editing=!1,"Input your username"!=$scope.nick&&""!=$scope.nick?webrtc.sendDirectlyToAll($scope.room,"nick",$scope.nick):""==$scope.nick&&($scope.nick="Input your username")},$scope.setNick=function(){webrtc.sendDirectlyToAll($scope.room,"nick",$scope.nick)},$scope.editItem=function(){$scope.editing=!0,$scope.nick=""},webrtc.on("channelMessage",function(peer,label,data){if("chat"===data.type){var id=peer.id,activeID=$(".mes.active").attr("id"),from=void 0===peer.nick?id:peer.nick;activeID!=id?($(".mes.active").removeClass("active"),$("#conversation").append("<div id='"+id+"' class='mes other active'><p class='from'>"+from+"</p><p class='content'>"+data.payload+"<br></p></div>")):$(".mes.active .content").append(data.payload+"<br>")}else if("nick"===data.type){from=void 0!==peer.nick?peer.nick:peer.id;ngNoti.notification("changeName",from,data.payload),peer.nick=data.payload}else"lockStatus"===data.type&&("true"==data.payload?$("button[name='lock'] i").toggleClass("fa-lock").toggleClass("fa-unlock"):$("button[name='lock'] i").toggleClass("fa-unlock").toggleClass("fa-lock"))});var peers=[];webrtc.on("createdPeer",function(peer){console.log("createdPeer",peer);var remotes=document.getElementById("remotes");console.log(peer),peers.push(peer),console.log(peers),remotes&&(peer&&peer.pc&&peer.pc.on("iceConnectionStateChange",function(event){var state=peer.pc.iceConnectionState;switch(console.log("state",state),state){case"checking":case"connected":case"completed":case"disconnected":case"failed":break;case"closed":var index=peers.indexOf(peer);index>-1&&peers.splice(index,1),console.log(peers)}}),peer.on("fileTransfer",function(metadata,receiver){console.log("incoming filetransfer",metadata),receiver.on("receivedFile",function(file,metadata){console.log("received file",metadata.name,metadata.size),$("#conversation").append("<p class='file'>You just received a file named '"+metadata.name+"'</p><a href='"+URL.createObjectURL(file)+"' download='"+metadata.name+"'>Download</a>"),receiver.channel.close()}),$(".mes.active").removeClass("active")}))});var fileToAll=document.getElementById("fileToAll");fileToAll.addEventListener("change",function(){var file=fileToAll.files[0];console.log(file);var i=0;for(console.log(peers),i;i<peers.length;i++)peers[i].sendFile(file);$("#conversation").append("<p class='file'>You just send a file named '"+file.name+"'</p><a href='"+URL.createObjectURL(file)+"' download='"+file.name+"'>Download</a>"),$(".mes.active").removeClass("active")})}return RoomController.$inject=["$rootScope","$scope","$routeParams","$location","ngNoti"],RoomController}(),Config=function(){function Config($routeProvider){$routeProvider.when("/",{templateUrl:"js/controllers/home/view.html",controller:"homeController"}).when("/:roomName",{templateUrl:"js/controllers/room/view.html",controller:"roomController"})}return Config.$inject=["$routeProvider"],Config}(),app=angular.module("app",["ngRoute"]).config(Config).service("ngNoti",Noti).service("ngCopy",Copy).directive("ngClickCopy",ClickCopy).controller("homeController",HomeController).controller("roomController",RoomController);